# ChiBank/QRPay 部署文档

本文档详细说明了 ChiBank/QRPay 支付网关系统的打包、上传和部署流程。

## 目录

1. [快速开始](#快速开始)
2. [部署方式](#部署方式)
3. [Docker 部署](#docker-部署)
4. [传统部署](#传统部署)
5. [CI/CD 自动化部署](#cicd-自动化部署)
6. [环境配置](#环境配置)
7. [故障排除](#故障排除)

---

## 快速开始

### 前置要求

- **开发环境**:
  - PHP >= 8.0.2
  - Composer 2.x
  - Node.js >= 20.x
  - MySQL >= 8.0 或 MariaDB >= 10.3
  
- **生产环境**（Docker 部署）:
  - Docker >= 20.x
  - Docker Compose >= 2.x

### 一键构建

```bash
# 克隆项目
git clone https://github.com/LILIANSRL/chibank-.git
cd chibank-

# 运行构建脚本
./scripts/build.sh

# 或使用生产模式
./scripts/build.sh --prod
```

---

## 部署方式

ChiBank/QRPay 支持三种部署方式：

1. **Docker 部署**（推荐）- 最简单、最可靠的部署方式
2. **传统部署** - 适合传统服务器环境
3. **自动化 CI/CD** - 使用 GitHub Actions 自动化部署

---

## Docker 部署

### 方式一：使用 Docker Compose（推荐）

#### 1. 配置环境变量

```bash
# 复制环境变量示例文件
cp .env.example .env

# 编辑 .env 文件，配置以下关键参数：
# - APP_NAME=ChiBank
# - APP_ENV=production
# - APP_DEBUG=false
# - APP_URL=http://your-domain.com
# - DB_DATABASE=chibank
# - DB_USERNAME=chibank
# - DB_PASSWORD=your_secure_password
```

#### 2. 启动服务

```bash
# 构建并启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f app
```

#### 3. 初始化数据库

```bash
# 进入应用容器
docker-compose exec app sh

# 运行数据库迁移
php artisan migrate --force

# 运行数据库填充（可选）
php artisan db:seed

# 退出容器
exit
```

#### 4. 访问应用

打开浏览器访问: `http://localhost` 或您配置的域名

### 方式二：仅使用 Docker

#### 1. 构建 Docker 镜像

```bash
# 使用提供的脚本构建
./scripts/docker-build.sh --name chibank/qrpay --version v1.0.0

# 或直接使用 Docker 命令
docker build -t chibank/qrpay:latest .
```

#### 2. 运行容器

```bash
# 运行应用容器（需要单独配置数据库）
docker run -d \
  --name chibank-app \
  -p 80:80 \
  -e DB_HOST=your-db-host \
  -e DB_DATABASE=chibank \
  -e DB_USERNAME=chibank \
  -e DB_PASSWORD=your_password \
  chibank/qrpay:latest
```

#### 3. 推送到镜像仓库

```bash
# 登录 Docker Hub
docker login

# 推送镜像
./scripts/docker-build.sh --name your-username/chibank --version v1.0.0 --push
```

### Docker 常用命令

```bash
# 停止所有服务
docker-compose down

# 重启服务
docker-compose restart

# 查看容器日志
docker-compose logs -f [service_name]

# 进入容器
docker-compose exec app sh

# 清理未使用的镜像和容器
docker system prune -a
```

---

## 传统部署

### 1. 服务器准备

#### 安装必要软件

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y php8.1 php8.1-fpm php8.1-mysql php8.1-mbstring \
  php8.1-xml php8.1-bcmath php8.1-gd php8.1-curl \
  nginx mysql-server composer nodejs npm

# CentOS/RHEL
sudo yum install -y php81 php81-fpm php81-mysqlnd php81-mbstring \
  php81-xml php81-bcmath php81-gd php81-curl \
  nginx mysql-server composer nodejs npm
```

### 2. 下载和配置

```bash
# 克隆代码到服务器
cd /var/www
git clone https://github.com/LILIANSRL/chibank-.git chibank
cd chibank

# 设置权限
sudo chown -R www-data:www-data /var/www/chibank
sudo chmod -R 755 /var/www/chibank/storage
sudo chmod -R 755 /var/www/chibank/bootstrap/cache
```

### 3. 安装依赖和构建

```bash
# 使用构建脚本
./scripts/build.sh --prod

# 或手动执行
composer install --no-dev --optimize-autoloader
npm ci
npm run build
```

### 4. 配置环境

```bash
# 创建环境文件
cp .env.example .env
php artisan key:generate

# 编辑 .env 文件
nano .env
```

### 5. 数据库设置

```bash
# 创建数据库
mysql -u root -p
CREATE DATABASE chibank CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'chibank'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON chibank.* TO 'chibank'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# 运行迁移
php artisan migrate --force
php artisan db:seed
```

### 6. 配置 Nginx

创建 Nginx 配置文件 `/etc/nginx/sites-available/chibank`:

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/chibank/public;

    index index.php index.html;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

启用站点：

```bash
sudo ln -s /etc/nginx/sites-available/chibank /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 7. 优化性能

```bash
# 缓存配置
php artisan config:cache
php artisan route:cache
php artisan view:cache

# 优化自动加载
composer dump-autoload --optimize
```

---

## CI/CD 自动化部署

项目已配置 GitHub Actions 工作流，可实现自动化构建和部署。

### GitHub Actions 工作流

工作流文件位于 `.github/workflows/deploy.yml`，包含以下任务：

1. **构建和测试** - 在每次 push 和 pull request 时运行
2. **Docker 镜像构建** - 在 main/master/production 分支上构建
3. **自动部署** - 在 production 分支上部署

### 配置自动部署

#### 1. 设置 GitHub Secrets

在 GitHub 仓库设置中添加以下密钥：

- `DOCKER_USERNAME` - Docker Hub 用户名（可选）
- `DOCKER_PASSWORD` - Docker Hub 密码/令牌（可选）
- `DEPLOY_SSH_KEY` - 部署服务器的 SSH 私钥
- `DEPLOY_HOST` - 部署服务器主机名或 IP
- `DEPLOY_USER` - SSH 用户名
- `DEPLOY_PATH` - 部署路径

#### 2. 触发自动部署

```bash
# 推送到 production 分支触发部署
git checkout production
git merge main
git push origin production

# 或使用手动触发
# 在 GitHub Actions 页面点击 "Run workflow"
```

### 手动部署脚本

如果不使用自动化部署，可使用提供的部署脚本：

```bash
# 在服务器上
cd /var/www/chibank
./scripts/deploy.sh
```

脚本会执行以下操作：
1. 进入维护模式
2. 拉取最新代码
3. 更新依赖
4. 构建前端资源
5. 运行数据库迁移（需确认）
6. 清除和重建缓存
7. 退出维护模式

---

## 环境配置

### 关键环境变量

```env
# 应用配置
APP_NAME=ChiBank
APP_ENV=production
APP_KEY=base64:xxxxx  # 使用 php artisan key:generate 生成
APP_DEBUG=false
APP_URL=https://your-domain.com

# 数据库配置
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=chibank
DB_USERNAME=chibank
DB_PASSWORD=your_secure_password

# 缓存配置
CACHE_DRIVER=redis
QUEUE_CONNECTION=redis
SESSION_DRIVER=redis

# Redis 配置
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

# 邮件配置
MAIL_MAILER=smtp
MAIL_HOST=smtp.example.com
MAIL_PORT=587
MAIL_USERNAME=your_email@example.com
MAIL_PASSWORD=your_email_password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@your-domain.com
MAIL_FROM_NAME="${APP_NAME}"
```

### 生产环境优化建议

1. **启用 OPcache**
   ```ini
   # php.ini
   opcache.enable=1
   opcache.memory_consumption=256
   opcache.max_accelerated_files=20000
   ```

2. **配置队列处理器**
   ```bash
   # 使用 Supervisor 管理队列
   sudo apt install supervisor
   
   # 创建配置文件 /etc/supervisor/conf.d/chibank-worker.conf
   [program:chibank-worker]
   process_name=%(program_name)s_%(process_num)02d
   command=php /var/www/chibank/artisan queue:work --sleep=3 --tries=3
   autostart=true
   autorestart=true
   user=www-data
   numprocs=2
   redirect_stderr=true
   stdout_logfile=/var/www/chibank/storage/logs/worker.log
   ```

3. **设置定时任务**
   ```bash
   # 添加到 crontab
   * * * * * cd /var/www/chibank && php artisan schedule:run >> /dev/null 2>&1
   ```

4. **配置 SSL/HTTPS**
   ```bash
   # 使用 Let's Encrypt
   sudo apt install certbot python3-certbot-nginx
   sudo certbot --nginx -d your-domain.com
   ```

---

## 故障排除

### 常见问题

#### 1. 500 服务器错误

```bash
# 检查日志
tail -f storage/logs/laravel.log

# 检查权限
sudo chown -R www-data:www-data storage bootstrap/cache
sudo chmod -R 755 storage bootstrap/cache

# 清除缓存
php artisan cache:clear
php artisan config:clear
php artisan view:clear
```

#### 2. 前端资源加载失败

```bash
# 重新构建前端资源
npm run build

# 检查 public/build 目录是否存在
ls -la public/build/

# 检查 .env 中的 APP_URL 是否正确
```

#### 3. 数据库连接失败

```bash
# 测试数据库连接
php artisan tinker
>>> DB::connection()->getPdo();

# 检查 MySQL 服务
sudo systemctl status mysql

# 检查防火墙
sudo ufw status
```

#### 4. Docker 容器无法启动

```bash
# 查看容器日志
docker-compose logs app

# 检查端口占用
sudo netstat -tulpn | grep :80

# 重新构建镜像
docker-compose build --no-cache
docker-compose up -d
```

#### 5. 文件上传问题

```bash
# 检查上传目录权限
chmod 755 storage/app/public
php artisan storage:link

# 检查 PHP 配置
php -i | grep upload_max_filesize
php -i | grep post_max_size
```

### 性能问题

#### 应用响应慢

```bash
# 启用缓存
php artisan config:cache
php artisan route:cache
php artisan view:cache

# 优化自动加载
composer dump-autoload --optimize --classmap-authoritative

# 检查数据库查询
# 在 .env 中启用查询日志
DB_LOG_QUERIES=true
```

#### 内存不足

```bash
# 增加 PHP 内存限制
# 在 php.ini 中
memory_limit = 512M

# 优化 Composer
php -d memory_limit=-1 /usr/local/bin/composer install
```

### 获取帮助

如遇到无法解决的问题，请：

1. 查看详细日志: `storage/logs/laravel.log`
2. 检查 GitHub Issues: https://github.com/LILIANSRL/chibank-/issues
3. 查阅完整文档: `docs/zh-CN/操作文档.md`

---

## 总结

本部署文档涵盖了 ChiBank/QRPay 的所有部署方式：

- ✅ **Docker 部署**（推荐）- 快速、可靠、易于维护
- ✅ **传统部署** - 灵活、适合定制化需求
- ✅ **自动化 CI/CD** - 高效、适合团队协作

选择最适合您需求的部署方式，享受 ChiBank/QRPay 带来的便捷支付体验！
